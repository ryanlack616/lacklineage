<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atlas ‚Äî Lack Lineage</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #1a1714;
  --fg: #e8e4dc;
  --fg2: #9a9590;
  --accent: #d4a832;
  --accent2: #8b6914;
  --border: #3a352e;
  --font: 'Georgia', 'Times New Roman', serif;
  --mono: 'Consolas', 'Monaco', monospace;
  --panel-bg: rgba(26,23,20,0.94);
}
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--font);
  color: var(--fg);
  background: var(--bg);
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  background: #1a1714;
  color: #f8f6f1;
  padding: 0.5rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 2rem;
  z-index: 100;
  flex-shrink: 0;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
header h1 { font-size: 1rem; letter-spacing: 0.05em; white-space: nowrap; }
header h1 a { color: inherit; text-decoration: none; }
nav { display: flex; gap: 0.4rem; flex-wrap: wrap; }
nav a {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  color: #f8f6f1;
  padding: 0.25rem 0.6rem;
  border-radius: 6px;
  font-size: 0.75rem;
  text-decoration: none;
  transition: all 0.15s;
}
nav a:hover, nav a.active { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
nav a.active { font-weight: bold; }

/* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
#map {
  flex: 1;
  position: relative;
}

/* ‚îÄ‚îÄ Side Panel ‚îÄ‚îÄ */
.panel {
  position: absolute;
  top: 0.75rem;
  left: 0.75rem;
  width: 320px;
  max-height: calc(100% - 1.5rem);
  background: var(--panel-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(12px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.panel-header {
  padding: 1rem 1.2rem 0.75rem;
  border-bottom: 1px solid var(--border);
}
.panel-header h2 {
  font-size: 1.05rem;
  font-weight: 400;
  letter-spacing: 0.08em;
  color: var(--accent);
  margin-bottom: 0.25rem;
}
.panel-stats {
  display: flex; gap: 1rem;
  font-size: 0.72rem; color: var(--fg2);
}
.panel-stats .v { color: var(--fg); font-weight: bold; }

/* ‚îÄ‚îÄ Filter buttons ‚îÄ‚îÄ */
.panel-filters {
  padding: 0.5rem 1.2rem;
  border-bottom: 1px solid var(--border);
  display: flex; flex-wrap: wrap; gap: 0.35rem;
}
.panel-filters button {
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  color: var(--fg);
  padding: 0.25rem 0.6rem;
  border-radius: 5px;
  font-family: var(--font);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.15s;
}
.panel-filters button:hover { background: rgba(212,168,50,0.15); border-color: var(--accent); }
.panel-filters button.active { background: rgba(212,168,50,0.2); border-color: var(--accent); color: var(--accent); }

/* ‚îÄ‚îÄ Detail area ‚îÄ‚îÄ */
.panel-detail {
  flex: 1;
  overflow-y: auto;
  padding: 0.75rem 1.2rem;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.panel-detail::-webkit-scrollbar { width: 5px; }
.panel-detail::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.detail-empty {
  color: var(--fg2); font-size: 0.8rem; font-style: italic;
  padding: 1rem 0; text-align: center;
}
.detail-title { font-size: 0.95rem; color: var(--accent); margin-bottom: 0.4rem; }
.detail-counts {
  display: flex; gap: 0.75rem; font-size: 0.7rem; color: var(--fg2);
  margin-bottom: 0.6rem; padding-bottom: 0.4rem;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.detail-counts span { color: var(--fg); font-weight: bold; }

.person-list { list-style: none; }
.person-item {
  display: flex; align-items: baseline; gap: 0.5rem;
  padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.04);
}
.person-item a { color: var(--fg); text-decoration: none; font-size: 0.78rem; transition: color 0.15s; }
.person-item a:hover { color: var(--accent); }
.person-dates { font-size: 0.68rem; color: var(--fg2); white-space: nowrap; }
.person-type {
  font-size: 0.58rem; padding: 0.1rem 0.3rem; border-radius: 3px; white-space: nowrap;
}
.person-type.birth { background: rgba(100,180,255,0.15); color: #7bb8f0; }
.person-type.death { background: rgba(255,150,100,0.15); color: #e8a070; }
.person-type.both { background: rgba(212,168,50,0.15); color: var(--accent); }

.tier-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.tier-dot.high { background: #4a4; }
.tier-dot.medium { background: #aa4; }
.tier-dot.low { background: #a44; }
.tier-dot.unknown { background: #666; }

/* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
.legend {
  position: absolute;
  bottom: 1rem; right: 0.75rem;
  background: var(--panel-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.5rem 0.8rem;
  font-size: 0.62rem;
  color: var(--fg2);
  z-index: 10;
  backdrop-filter: blur(8px);
}
.legend-title { color: var(--fg); font-size: 0.7rem; margin-bottom: 0.25rem; }
.legend-row { display: flex; align-items: center; gap: 0.4rem; margin: 0.12rem 0; }
.legend-swatch { width: 10px; height: 10px; border-radius: 2px; }

/* ‚îÄ‚îÄ Cluster badge ‚îÄ‚îÄ */
.cluster-marker {
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
  font-family: var(--mono);
  font-size: 0.7rem;
  font-weight: bold;
  color: #fff;
  border: 2px solid rgba(255,255,255,0.4);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  cursor: pointer;
  transition: transform 0.15s;
}
.cluster-marker:hover { transform: scale(1.15); }

/* ‚îÄ‚îÄ Popup ‚îÄ‚îÄ */
.maplibregl-popup-content {
  background: var(--panel-bg) !important;
  border: 1px solid var(--border) !important;
  border-radius: 8px !important;
  color: var(--fg) !important;
  font-family: var(--font) !important;
  font-size: 0.78rem !important;
  padding: 0.6rem 0.8rem !important;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5) !important;
  max-width: 260px !important;
}
.maplibregl-popup-tip { border-top-color: var(--panel-bg) !important; }
.maplibregl-popup-close-button { color: var(--fg2) !important; font-size: 1.1rem !important; }
.popup-name { color: var(--accent); font-size: 0.85rem; margin-bottom: 0.15rem; }
.popup-info { color: var(--fg2); font-size: 0.7rem; }

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.loading-overlay {
  position: absolute; inset: 0;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  z-index: 200;
  transition: opacity 0.6s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-text {
  color: var(--accent); font-size: 1rem; letter-spacing: 0.1em;
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100% { opacity:0.4; } 50% { opacity:1; } }

/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media (max-width: 700px) {
  .panel { width: 100%; left: 0; top: auto; bottom: 0; max-height: 40vh; border-radius: 10px 10px 0 0; }
  .legend { display: none; }
  header { padding: 0.4rem 0.8rem; gap: 0.8rem; }
  header h1 { font-size: 0.85rem; }
  nav a { font-size: 0.65rem; padding: 0.2rem 0.4rem; }
}
</style>
</head>
<body>
<header>
  <h1><a href="/">Lack Lineage</a></h1>
  <nav>
    <a href="/">Home</a>
    <a href="/dashboard.html">Dashboard</a>
    <a href="/search.html">Search</a>
    <a href="/research.html">Research</a>
    <a href="/graph.html">Graph</a>
    <a href="/places.html">Places</a>
    <a href="/tree.html">Tree</a>
    <a href="/globe.html">Globe</a>
    <a href="/atlas.html" class="active">Atlas</a>
    <a href="/rivers.html">Rivers</a>
  </nav>
</header>

<div id="map">
  <div class="loading-overlay" id="loading">
    <div class="loading-text">Loading atlas&hellip;</div>
  </div>

  <!-- Side panel -->
  <div class="panel" id="panel">
    <div class="panel-header">
      <h2>LIVING ATLAS</h2>
      <div class="panel-stats">
        <div><span class="v" id="st-loc">‚Äî</span> locations</div>
        <div><span class="v" id="st-ppl">‚Äî</span> people</div>
        <div><span class="v" id="st-mig">‚Äî</span> migrations</div>
      </div>
    </div>
    <div class="panel-filters">
      <button id="btn-all" class="active">All</button>
      <button id="btn-births">Births</button>
      <button id="btn-deaths">Deaths</button>
      <button id="btn-arcs">Migrations</button>
      <button id="btn-cluster">Clusters</button>
      <button id="btn-reset">Reset</button>
    </div>
    <div class="panel-detail" id="detail">
      <div class="detail-empty">Click a marker to see who lived there.<br>Zoom into Pennsylvania for county-level detail.</div>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-title">Era</div>
    <div class="legend-row"><div class="legend-swatch" style="background:#5588cc;"></div> Pre-1800</div>
    <div class="legend-row"><div class="legend-swatch" style="background:#44aa99;"></div> 1800s</div>
    <div class="legend-row"><div class="legend-swatch" style="background:#d4a832;"></div> 1900s</div>
    <div class="legend-row"><div class="legend-swatch" style="background:#ee8844;"></div> 2000s</div>
    <div class="legend-row"><div class="legend-swatch" style="background:transparent; border:1px solid rgba(212,168,50,0.6);"></div> Migration arc</div>
  </div>
</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="/data/help-widget.js"></script>
<script>
(function() {
  'use strict';

  const ERA_COLORS = {
    'pre1800': '#5588cc',
    '1800s':   '#44aa99',
    '1900s':   '#d4a832',
    '2000s':   '#ee8844',
    'unknown': '#888888'
  };
  const ARC_COLORS = {
    'pre1800': 'rgba(85,136,204,0.55)',
    '1800s':   'rgba(68,170,153,0.55)',
    '1900s':   'rgba(212,168,50,0.55)',
    '2000s':   'rgba(238,136,68,0.55)',
    'unknown': 'rgba(136,136,136,0.35)'
  };

  let globeData = null;
  let map = null;
  let viewMode = 'all';
  let showArcs = false;
  let showClusters = true;
  let markers = [];
  let arcLayerAdded = false;

  const detail = document.getElementById('detail');
  const loading = document.getElementById('loading');

  // ‚îÄ‚îÄ‚îÄ Load data ‚îÄ‚îÄ‚îÄ
  fetch('/data/globe.json')
    .then(r => r.json())
    .then(data => {
      globeData = data;
      initMap(data);
    })
    .catch(err => {
      loading.querySelector('.loading-text').textContent = 'Failed to load data';
      console.error(err);
    });

  function initMap(data) {
    document.getElementById('st-loc').textContent = data.stats.totalPoints.toLocaleString();
    document.getElementById('st-ppl').textContent = data.stats.totalPeopleMapped.toLocaleString();
    document.getElementById('st-mig').textContent = data.stats.totalArcs.toLocaleString();

    // Use free OpenFreeMap tiles ‚Äî bright daytime style
    map = new maplibregl.Map({
      container: 'map',
      style: 'https://tiles.openfreemap.org/styles/positron',
      center: [-78.5, 40.5],
      zoom: 5.5,
      minZoom: 2,
      maxZoom: 16,
      attributionControl: false
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-left');

    map.on('load', () => {
      addPointSources(data);
      addArcSource(data);
      loading.classList.add('hidden');
      setTimeout(() => loading.style.display = 'none', 600);
    });
  }

  // ‚îÄ‚îÄ‚îÄ Points as GeoJSON source with clustering ‚îÄ‚îÄ‚îÄ
  function addPointSources(data) {
    const geojson = {
      type: 'FeatureCollection',
      features: data.points.map(p => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [p.lng, p.lat] },
        properties: {
          place: p.place,
          births: p.births,
          deaths: p.deaths,
          total: p.total,
          era: dominantEra(p),
          _idx: data.points.indexOf(p)
        }
      }))
    };

    // Clustered source
    map.addSource('points-clustered', {
      type: 'geojson',
      data: geojson,
      cluster: true,
      clusterMaxZoom: 10,
      clusterRadius: 50,
      clusterProperties: {
        totalSum: ['+', ['get', 'total']]
      }
    });

    // Cluster circles
    map.addLayer({
      id: 'clusters',
      type: 'circle',
      source: 'points-clustered',
      filter: ['has', 'point_count'],
      paint: {
        'circle-color': [
          'step', ['get', 'point_count'],
          'rgba(212,168,50,0.6)', 10,
          'rgba(212,168,50,0.7)', 30,
          'rgba(212,168,50,0.8)'
        ],
        'circle-radius': [
          'step', ['get', 'point_count'],
          18, 10, 24, 30, 32
        ],
        'circle-stroke-width': 2,
        'circle-stroke-color': 'rgba(255,255,255,0.3)'
      }
    });

    // Cluster count labels
    map.addLayer({
      id: 'cluster-count',
      type: 'symbol',
      source: 'points-clustered',
      filter: ['has', 'point_count'],
      layout: {
        'text-field': '{point_count_abbreviated}',
        'text-font': ['Open Sans Bold'],
        'text-size': 12
      },
      paint: {
        'text-color': '#ffffff'
      }
    });

    // Individual points (unclustered)
    map.addLayer({
      id: 'point-markers',
      type: 'circle',
      source: 'points-clustered',
      filter: ['!', ['has', 'point_count']],
      paint: {
        'circle-color': [
          'match', ['get', 'era'],
          'pre1800', '#5588cc',
          '1800s', '#44aa99',
          '1900s', '#d4a832',
          '2000s', '#ee8844',
          '#888888'
        ],
        'circle-radius': [
          'interpolate', ['linear'], ['get', 'total'],
          1, 5,
          10, 10,
          50, 16,
          100, 22
        ],
        'circle-stroke-width': 1.5,
        'circle-stroke-color': 'rgba(255,255,255,0.5)',
        'circle-opacity': 0.85
      }
    });

    // Glow behind points
    map.addLayer({
      id: 'point-glow',
      type: 'circle',
      source: 'points-clustered',
      filter: ['!', ['has', 'point_count']],
      paint: {
        'circle-color': [
          'match', ['get', 'era'],
          'pre1800', '#5588cc',
          '1800s', '#44aa99',
          '1900s', '#d4a832',
          '2000s', '#ee8844',
          '#888888'
        ],
        'circle-radius': [
          'interpolate', ['linear'], ['get', 'total'],
          1, 10,
          10, 18,
          50, 28,
          100, 36
        ],
        'circle-opacity': 0.15,
        'circle-blur': 1
      }
    }, 'point-markers');

    // ‚îÄ‚îÄ‚îÄ Interactions ‚îÄ‚îÄ‚îÄ
    // Click cluster ‚Üí zoom in
    map.on('click', 'clusters', (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
      const clusterId = features[0].properties.cluster_id;
      map.getSource('points-clustered').getClusterExpansionZoom(clusterId, (err, zoom) => {
        if (err) return;
        map.easeTo({
          center: features[0].geometry.coordinates,
          zoom: zoom + 1
        });
      });
    });

    // Click point ‚Üí show detail
    map.on('click', 'point-markers', (e) => {
      const f = e.features[0];
      const idx = f.properties._idx;
      const pt = globeData.points[idx];
      if (pt) showPointDetail(pt);

      // Fly to
      map.easeTo({ center: f.geometry.coordinates, zoom: Math.max(map.getZoom(), 8) });
    });

    // Hover cursors
    map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
    map.on('mouseenter', 'point-markers', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const f = e.features[0];
      const idx = f.properties._idx;
      const pt = globeData.points[idx];
      if (pt) {
        new maplibregl.Popup({ closeButton: false, closeOnClick: false, offset: 12 })
          .setLngLat(f.geometry.coordinates)
          .setHTML(`<div class="popup-name">${escHtml(pt.place)}</div><div class="popup-info">${pt.total} people ¬∑ ${pt.births} born ¬∑ ${pt.deaths} died</div>`)
          .addTo(map);
      }
    });
    map.on('mouseleave', 'point-markers', () => {
      map.getCanvas().style.cursor = '';
      // Remove popups
      document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
    });
  }

  // ‚îÄ‚îÄ‚îÄ Migration arcs as GeoJSON lines ‚îÄ‚îÄ‚îÄ
  function addArcSource(data) {
    const features = data.arcs.map(a => {
      // Create great-circle-ish curve with intermediate points
      const pts = generateArcPoints(a.startLng, a.startLat, a.endLng, a.endLat, 30);
      return {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: pts },
        properties: {
          name: a.name,
          from: a.from,
          to: a.to,
          dates: a.dates,
          era: a.era
        }
      };
    });

    map.addSource('arcs', {
      type: 'geojson',
      data: { type: 'FeatureCollection', features }
    });

    // Arc glow
    map.addLayer({
      id: 'arc-glow',
      type: 'line',
      source: 'arcs',
      layout: { visibility: 'none', 'line-cap': 'round', 'line-join': 'round' },
      paint: {
        'line-color': [
          'match', ['get', 'era'],
          'pre1800', 'rgba(85,136,204,0.12)',
          '1800s', 'rgba(68,170,153,0.12)',
          '1900s', 'rgba(212,168,50,0.12)',
          '2000s', 'rgba(238,136,68,0.12)',
          'rgba(136,136,136,0.08)'
        ],
        'line-width': 6,
        'line-blur': 4
      }
    }, 'point-glow');

    // Arc lines
    map.addLayer({
      id: 'arc-lines',
      type: 'line',
      source: 'arcs',
      layout: { visibility: 'none', 'line-cap': 'round', 'line-join': 'round' },
      paint: {
        'line-color': [
          'match', ['get', 'era'],
          'pre1800', '#5588cc',
          '1800s', '#44aa99',
          '1900s', '#d4a832',
          '2000s', '#ee8844',
          '#888888'
        ],
        'line-width': 1.2,
        'line-opacity': 0.5,
        'line-dasharray': [2, 3]
      }
    }, 'point-glow');

    arcLayerAdded = true;

    // Arc hover
    map.on('mouseenter', 'arc-lines', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const f = e.features[0];
      const mid = e.lngLat;
      new maplibregl.Popup({ closeButton: false, closeOnClick: false, offset: 8 })
        .setLngLat(mid)
        .setHTML(`<div class="popup-name">${escHtml(f.properties.name)} ${f.properties.dates ? '(' + escHtml(f.properties.dates) + ')' : ''}</div><div class="popup-info">${escHtml(f.properties.from)} ‚Üí ${escHtml(f.properties.to)}</div>`)
        .addTo(map);
    });
    map.on('mouseleave', 'arc-lines', () => {
      map.getCanvas().style.cursor = '';
      document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
    });
  }

  // ‚îÄ‚îÄ‚îÄ Generate curved arc points ‚îÄ‚îÄ‚îÄ
  function generateArcPoints(lng1, lat1, lng2, lat2, numPts) {
    const points = [];
    const toRad = Math.PI / 180;
    const toDeg = 180 / Math.PI;

    const phi1 = lat1 * toRad, lam1 = lng1 * toRad;
    const phi2 = lat2 * toRad, lam2 = lng2 * toRad;

    const dPhi = phi2 - phi1;
    const dLam = lam2 - lam1;
    const a = Math.sin(dPhi / 2) ** 2 + Math.cos(phi1) * Math.cos(phi2) * Math.sin(dLam / 2) ** 2;
    const d = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    if (d < 0.001) return [[lng1, lat1], [lng2, lat2]];

    for (let i = 0; i <= numPts; i++) {
      const f = i / numPts;
      const A = Math.sin((1 - f) * d) / Math.sin(d);
      const B = Math.sin(f * d) / Math.sin(d);
      const x = A * Math.cos(phi1) * Math.cos(lam1) + B * Math.cos(phi2) * Math.cos(lam2);
      const y = A * Math.cos(phi1) * Math.sin(lam1) + B * Math.cos(phi2) * Math.sin(lam2);
      const z = A * Math.sin(phi1) + B * Math.sin(phi2);
      const lat = Math.atan2(z, Math.sqrt(x * x + y * y)) * toDeg;
      const lng = Math.atan2(y, x) * toDeg;
      points.push([lng, lat]);
    }
    return points;
  }

  // ‚îÄ‚îÄ‚îÄ Dominant era helper ‚îÄ‚îÄ‚îÄ
  function dominantEra(p) {
    const eras = {};
    p.people.forEach(pp => { eras[pp.era] = (eras[pp.era] || 0) + 1; });
    let best = 'unknown', bc = 0;
    for (const [e, c] of Object.entries(eras)) { if (c > bc) { best = e; bc = c; } }
    return best;
  }

  // ‚îÄ‚îÄ‚îÄ Show detail ‚îÄ‚îÄ‚îÄ
  function showPointDetail(pt) {
    let people = pt.people;
    if (viewMode === 'births') people = people.filter(p => p.type === 'birth' || p.type === 'both');
    if (viewMode === 'deaths') people = people.filter(p => p.type === 'death' || p.type === 'both');

    let html = `<h3 class="detail-title">${escHtml(pt.place)}</h3>`;
    html += `<div class="detail-counts">
      <div><span>${pt.births}</span> born</div>
      <div><span>${pt.deaths}</span> died</div>
      <div><span>${pt.total}</span> total</div>
    </div>`;
    html += '<ul class="person-list">';
    people.forEach(p => {
      html += `<li class="person-item">
        <div class="tier-dot ${p.tier}"></div>
        <a href="/profile.html?id=${p.id}">${escHtml(p.name)}</a>
        <span class="person-dates">${escHtml(p.dates)}</span>
        <span class="person-type ${p.type}">${p.type}</span>
      </li>`;
    });
    html += '</ul>';
    detail.innerHTML = html;
  }

  // ‚îÄ‚îÄ‚îÄ Controls ‚îÄ‚îÄ‚îÄ
  document.getElementById('btn-all').addEventListener('click', () => setView('all'));
  document.getElementById('btn-births').addEventListener('click', () => setView('births'));
  document.getElementById('btn-deaths').addEventListener('click', () => setView('deaths'));
  document.getElementById('btn-arcs').addEventListener('click', toggleArcs);
  document.getElementById('btn-cluster').addEventListener('click', toggleClusters);
  document.getElementById('btn-reset').addEventListener('click', resetView);

  function setView(mode) {
    viewMode = mode;
    document.querySelectorAll('.panel-filters button').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + mode).classList.add('active');
    if (showArcs) document.getElementById('btn-arcs').classList.add('active');
    if (showClusters) document.getElementById('btn-cluster').classList.add('active');

    // Update point filter
    if (map && map.getLayer('point-markers')) {
      if (mode === 'births') {
        map.setFilter('point-markers', ['all', ['!', ['has', 'point_count']], ['>', ['get', 'births'], 0]]);
        map.setFilter('point-glow', ['all', ['!', ['has', 'point_count']], ['>', ['get', 'births'], 0]]);
      } else if (mode === 'deaths') {
        map.setFilter('point-markers', ['all', ['!', ['has', 'point_count']], ['>', ['get', 'deaths'], 0]]);
        map.setFilter('point-glow', ['all', ['!', ['has', 'point_count']], ['>', ['get', 'deaths'], 0]]);
      } else {
        map.setFilter('point-markers', ['!', ['has', 'point_count']]);
        map.setFilter('point-glow', ['!', ['has', 'point_count']]);
      }
    }
  }

  function toggleArcs() {
    showArcs = !showArcs;
    document.getElementById('btn-arcs').classList.toggle('active', showArcs);
    if (map && arcLayerAdded) {
      map.setLayoutProperty('arc-lines', 'visibility', showArcs ? 'visible' : 'none');
      map.setLayoutProperty('arc-glow', 'visibility', showArcs ? 'visible' : 'none');
    }
  }

  function toggleClusters() {
    showClusters = !showClusters;
    document.getElementById('btn-cluster').classList.toggle('active', showClusters);
    if (map) {
      map.setLayoutProperty('clusters', 'visibility', showClusters ? 'visible' : 'none');
      map.setLayoutProperty('cluster-count', 'visibility', showClusters ? 'visible' : 'none');
    }
  }

  function resetView() {
    viewMode = 'all';
    showArcs = false;
    showClusters = true;
    document.querySelectorAll('.panel-filters button').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-all').classList.add('active');
    document.getElementById('btn-cluster').classList.add('active');
    if (map) {
      map.setFilter('point-markers', ['!', ['has', 'point_count']]);
      map.setFilter('point-glow', ['!', ['has', 'point_count']]);
      map.setLayoutProperty('arc-lines', 'visibility', 'none');
      map.setLayoutProperty('arc-glow', 'visibility', 'none');
      map.setLayoutProperty('clusters', 'visibility', 'visible');
      map.setLayoutProperty('cluster-count', 'visibility', 'visible');
      map.flyTo({ center: [-78.5, 40.5], zoom: 5.5, duration: 1200 });
    }
    detail.innerHTML = '<div class="detail-empty">Click a marker to see who lived there.<br>Zoom into Pennsylvania for county-level detail.</div>';
  }

  function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // ‚îÄ‚îÄ‚îÄ Help ‚îÄ‚îÄ‚îÄ
  if (typeof initHelp === 'function') {
    initHelp({
      title: 'Atlas',
      intro: 'An interactive flat map showing family locations with country, state, and county boundaries. Zoom in for detail ‚Äî zoom out for the big picture.',
      keyboard: [
        { key: '?', action: 'Toggle this help panel' }
      ],
      mouse: [
        { key: 'Left-drag', action: 'Pan the map' },
        { key: 'Scroll', action: 'Zoom in/out' },
        { key: 'Click marker', action: 'Show people at that location' },
        { key: 'Click cluster', action: 'Zoom into cluster' },
        { key: 'Hover marker', action: 'Show location tooltip' }
      ],
      sections: [
        { title: 'Views', icon: 'üó∫Ô∏è', html: '<p><strong>All/Births/Deaths</strong> filter point markers. <strong>Migrations</strong> shows curved arcs from birth ‚Üí death place. <strong>Clusters</strong> groups nearby points into badges at wide zoom.</p>' },
        { title: 'Boundaries', icon: 'üèõÔ∏è', html: '<p>The map shows country, state/province, and county boundaries automatically as you zoom in. At street level you can see individual towns where ancestors lived.</p>' },
        { title: 'Data', icon: 'üìä', html: '<p>Same data as the Globe view: geocoded birth and death places from the genealogy database. Click any marker to see the full list of people with links to profiles.</p>' }
      ]
    });
  }
})();
</script>
</body>
</html>
