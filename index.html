<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lack Lineage</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f8f6f1;
  --fg: #2a2520;
  --fg2: #6b6360;
  --accent: #8b6914;
  --border: #d8d2c8;
  --font: 'Georgia', 'Times New Roman', serif;
  --mono: 'Consolas', 'Monaco', monospace;
}
html { font-size: 16px; }
body {
  font-family: var(--font);
  color: var(--fg);
  background: var(--bg);
  line-height: 1.7;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: url('img/back.svg') center center / 100% auto no-repeat;
  opacity: 0.14;
  pointer-events: none;
  z-index: 0;
}
body > * { position: relative; z-index: 1; }
a { color: var(--accent); }

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  background: var(--fg);
  color: var(--bg);
  padding: 0.75rem 2rem;
  display: flex;
  align-items: center;
  gap: 2rem;
}
header h1 { font-size: 1.1rem; letter-spacing: 0.05em; white-space: nowrap; }
header h1 span { font-weight: 300; opacity: 0.6; }
header h1 a { color: inherit; text-decoration: none; }
nav { display: flex; gap: 0.5rem; }
nav a {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--bg);
  padding: 0.3rem 0.7rem;
  border-radius: 6px;
  font-size: 0.8rem;
  text-decoration: none;
  transition: all 0.15s;
}
nav a:hover, nav a.active { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.4); }
nav a.active { font-weight: bold; }

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
main {
  flex: 1;
  max-width: 680px;
  margin: 0 auto;
  padding: 4rem 2rem 3rem;
}
h2 {
  font-size: 2rem;
  font-weight: 400;
  letter-spacing: 0.08em;
  margin-bottom: 1.5rem;
  color: var(--fg);
}
.subtitle {
  font-size: 1.1rem;
  color: var(--fg2);
  margin-bottom: 2.5rem;
  max-width: 500px;
}
.stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 3rem;
}
.stat {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1.2rem;
  text-align: center;
}
.stat .n {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent);
  display: block;
  font-family: var(--mono);
}
.stat .label {
  font-size: 0.75rem;
  color: var(--fg2);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-top: 0.3rem;
  display: block;
}

.pieces {
  margin-top: 2rem;
}
.pieces h3 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--fg2);
  margin-bottom: 1rem;
}
.piece-list { list-style: none; }
.piece-list li { margin-bottom: 0.5rem; }
.piece-list a {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1rem;
  border: 1px solid var(--border);
  border-radius: 6px;
  text-decoration: none;
  color: var(--fg);
  background: #fff;
  transition: all 0.15s;
  width: 100%;
}
.piece-list a:hover {
  border-color: var(--accent);
  background: #fefcf6;
}
.piece-list .icon { font-size: 1.2rem; width: 2rem; text-align: center; }
.piece-list .title { font-weight: 600; }
.piece-list .desc {
  font-size: 0.8rem;
  color: var(--fg2);
  margin-left: auto;
}

footer {
  text-align: center;
  padding: 2rem;
  font-size: 0.75rem;
  color: var(--fg2);
  border-top: 1px solid var(--border);
}

@media (max-width: 600px) {
  header { padding: 0.75rem 1rem; gap: 0.75rem; flex-wrap: wrap; }
  nav { gap: 0.3rem; }
  nav a { padding: 0.25rem 0.5rem; font-size: 0.7rem; }
  main { padding: 2rem 1rem 2rem; }
  h2 { font-size: 1.5rem; }
  .subtitle { font-size: 0.95rem; }
  .stats { grid-template-columns: 1fr; gap: 0.6rem; }
  .stat .n { font-size: 1.4rem; }
  .piece-list .desc { display: none; }
}

/* ‚îÄ‚îÄ Search bar ‚îÄ‚îÄ */
.search-wrap {
  position: relative; margin-bottom: 0.4rem;
}
.search-wrap input {
  width: 100%; padding: 0.9rem 1rem 0.9rem 2.8rem;
  border: 2px solid var(--border); border-radius: 8px;
  font-size: 1rem; font-family: var(--font); background: #fff; outline: none;
  transition: border-color 0.2s;
}
.search-wrap input:focus { border-color: var(--accent); }
.search-wrap::before {
  content: 'üîç'; position: absolute; left: 0.8rem; top: 50%;
  transform: translateY(-50%); font-size: 1.1rem; pointer-events: none;
}
.search-dd {
  position: absolute; top: 100%; left: 0; right: 0;
  background: #fff; border: 1px solid var(--border); border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 380px; overflow-y: auto; z-index: 50;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12); display: none;
}
.search-dd.open { display: block; }
.sr {
  padding: 0.55rem 1rem; cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid #f0ede6; font-size: 0.88rem;
}
.sr:hover { background: #fefcf6; }
.sr-name { font-weight: 600; }
.sr-sub { color: var(--fg2); font-size: 0.78rem; }
.sr-tier {
  font-size: 0.6rem; padding: 0.12rem 0.4rem; border-radius: 3px;
  font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
  font-family: var(--mono); flex-shrink: 0;
}
.search-controls {
  display: flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem;
}
.search-hint {
  font-size: 0.72rem; color: var(--fg2); font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; flex: 1;
}
.search-hint kbd {
  background: #eae6dd; padding: 0.1rem 0.35rem; border-radius: 3px;
  font-family: var(--mono); font-size: 0.7rem; border: 1px solid var(--border);
}
.ocr-search-btn {
  display: inline-flex; align-items: center; gap: 0.35rem;
  padding: 0.3rem 0.7rem; border-radius: 5px;
  border: 1px solid var(--border); background: #fff;
  font-size: 0.72rem; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; color: var(--fg2);
  cursor: pointer; transition: all 0.15s; white-space: nowrap; user-select: none;
}
.ocr-search-btn:hover { border-color: var(--accent); color: var(--accent); }
.ocr-search-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.sr-ocr-snippet {
  font-size: 0.7rem; color: var(--fg2); font-family: var(--mono);
  margin-top: 0.15rem; max-width: 100%;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.sr-ocr-snippet mark {
  background: #fff3cd; color: var(--fg); padding: 0 0.15rem; border-radius: 2px;
}
.sr-via {
  font-size: 0.55rem; padding: 0.08rem 0.3rem; border-radius: 3px;
  font-weight: 600; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background: #e8f0fe; color: #1a56db;
  text-transform: uppercase; letter-spacing: 0.04em; margin-left: 0.4rem;
}
</style>
</head>
<body>

<header>
  <h1><a href=\"/\">Lack <span>Lineage</span></a></h1>
  <nav>
    <a href="/" class="active">Dashboard</a>
    <a href="/graph.html">Graph</a>
    <a href="/tree.html">Tree</a>
    <a href="/ancestry.html">Ancestry</a>
    <a href="/documents.html">Documents</a>
    <a href="/profile.html">Profile</a>
  </nav>
</header>

<main>
  <h2>LACK</h2>
  <p class="subtitle" id="subtitle">
    A family database. <span id="sub-count">1,251</span> people across five centuries.
    What we know, what we don't, and the shape of forgetting.
  </p>

  <!-- Search -->
  <div class="search-wrap" id="search-wrap">
    <input type="text" id="search-input" placeholder="Search by name‚Ä¶ use & for AND, | for OR" autocomplete="off">
    <div class="search-dd" id="search-dd"></div>
  </div>
  <div class="search-controls">
    <span class="search-hint"><kbd>&amp;</kbd> AND &nbsp; <kbd>|</kbd> OR &nbsp; spaces = AND</span>
    <button class="ocr-search-btn" id="ocr-search-btn" title="Also search OCR text from scanned documents">
      üìÑ Search OCR
    </button>
  </div>

  <div class="stats" id="stats">
    <div class="stat"><span class="n" id="s-people">‚Äî</span><span class="label">People</span></div>
    <div class="stat"><span class="n" id="s-surnames">‚Äî</span><span class="label">Surnames</span></div>
    <div class="stat"><span class="n" id="s-rels">‚Äî</span><span class="label">Relationships</span></div>
  </div>

  <div class="stats" id="confidence-stats" style="display:none">
    <div class="stat"><span class="n" id="s-avg-conf" style="color:#2d9a2d">‚Äî</span><span class="label">Avg Confidence</span></div>
    <div class="stat"><span class="n" id="s-high" style="color:#2d9a2d">‚Äî</span><span class="label">High ‚â• 80</span></div>
    <div class="stat"><span class="n" id="s-medium" style="color:#c9a100">‚Äî</span><span class="label">Medium 50-79</span></div>
  </div>

  <div class="pieces">
    <h3>Pieces</h3>
    <ul class="piece-list">
      <li>
        <a href="/graph.html">
          <span class="icon">‚óâ</span>
          <span class="title">Family Graph</span>
          <span class="desc">Force-directed network</span>
        </a>
      </li>
      <li>
        <a href="/tree.html">
          <span class="icon">üå≥</span>
          <span class="title">Tree Explorer</span>
          <span class="desc">Ancestors &amp; descendants</span>
        </a>
      </li>
      <li>
        <a href="/ancestry.html">
          <span class="icon">üìú</span>
          <span class="title">Ancestry View</span>
          <span class="desc">Pedigree chart</span>
        </a>
      </li>
      <li>
        <a href="/letter.html">
          <span class="icon">‚úâ</span>
          <span class="title">Letter to George</span>
          <span class="desc">What the database holds</span>
        </a>
      </li>
      <li>
        <a href="/documents.html">
          <span class="icon">üìÑ</span>
          <span class="title">Documents</span>
          <span class="desc">OCR'd photos &amp; records</span>
        </a>
      </li>
      <li>
        <a href="/profile.html">
          <span class="icon">üë§</span>
          <span class="title">Person Profile</span>
          <span class="desc">Full record &amp; confidence</span>
        </a>
      </li>
      <li>
        <a href="/living.html">
          <span class="icon">‚è≥</span>
          <span class="title">The Living Moment</span>
          <span class="desc">Who was alive when</span>
        </a>
      </li>
      <li>
        <a href="/surnames.html">
          <span class="icon">üî§</span>
          <span class="title">Surname Directory</span>
          <span class="desc">Browse by family name</span>
        </a>
      </li>
      <li>
        <a href="/related.html">
          <span class="icon">üîó</span>
          <span class="title">How Am I Related?</span>
          <span class="desc">Find connection paths</span>
        </a>
      </li>
      <li>
        <a href="/visualizations.html">
          <span class="icon">‚óà</span>
          <span class="title">Thirteen Ways to See a Family</span>
          <span class="desc">Planned visualizations</span>
        </a>
      </li>
    </ul>
  </div>

  <p style="margin-top: 3rem; font-size: 0.85rem; color: var(--fg2); line-height: 1.8;">
    Built from a database started by George Lack. Extended by
    <a href="https://monospacepoetry.com">Ryan Lack</a>.
    This project lives at the intersection of genealogy and art practice ‚Äî
    measuring what survives, performing what doesn't, and refusing to let
    people be forgotten.
  </p>
</main>

<footer>
  lacklineage.com ¬∑ 2026
</footer>

<script>
fetch('/data/stats.json')
  .then(r => r.json())
  .then(s => {
    document.getElementById('s-people').textContent = s.total_people.toLocaleString();
    document.getElementById('s-surnames').textContent = s.unique_surnames.toLocaleString();
    document.getElementById('s-rels').textContent = s.total_relationships.toLocaleString();
    document.getElementById('sub-count').textContent = s.total_people.toLocaleString();
    if (s.confidence) {
      document.getElementById('confidence-stats').style.display = 'grid';
      document.getElementById('s-avg-conf').textContent = s.confidence.average + '%';
      document.getElementById('s-high').textContent = s.confidence.high.toLocaleString();
      document.getElementById('s-medium').textContent = s.confidence.medium.toLocaleString();
    }
  })
  .catch(() => {});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Person Search ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let allProfiles = null;
let profileIndex = [];
let ocrMode = false;
const TIER_COLORS = { high:'#2d9a2d', medium:'#c9a100', low:'#d4740a', speculative:'#c0392b' };
const TIER_BG    = { high:'#e8f5e9', medium:'#fff8e1', low:'#fff3e0', speculative:'#fde8e8' };

fetch('/data/profiles.json')
  .then(r => r.json())
  .then(data => {
    allProfiles = data;
    profileIndex = Object.values(data).map(p => {
      const ocrParts = [];
      (p.documents||[]).forEach(d => {
        if (d.ocr_excerpt) ocrParts.push(d.ocr_excerpt.toLowerCase());
      });
      return {
        id: p.id, name: p.name, surname: p.surname||'',
        searchStr: (p.name+' '+(p.surname||'')).toLowerCase(),
        ocrStr: ocrParts.join(' '),
        birth_date: p.birth_date, death_date: p.death_date,
        confidence_tier: p.confidence_tier,
      };
    });
    profileIndex.sort((a,b) => a.name.localeCompare(b.name));
  })
  .catch(() => {});

function parseSearchQuery(raw) {
  return raw.split('|').map(g => g.trim()).filter(Boolean)
    .map(group => group.split('&').map(t => t.trim().toLowerCase()).filter(Boolean)
      .flatMap(t => t.split(/\s+/)).filter(Boolean));
}
function matchProfile(p, orGroups, useOcr) {
  for (const andTerms of orGroups) {
    if (!andTerms.length) continue;
    const nameMatch = andTerms.every(t => p.searchStr.includes(t));
    if (nameMatch) return { match: true, via: 'name' };
    if (useOcr && p.ocrStr) {
      const ocrMatch = andTerms.every(t => p.ocrStr.includes(t));
      if (ocrMatch) return { match: true, via: 'ocr', terms: andTerms };
    }
  }
  return { match: false };
}
function getOcrSnippet(personId, terms) {
  const docs = allProfiles[personId]?.documents || [];
  for (const d of docs) {
    if (!d.ocr_excerpt) continue;
    const lower = d.ocr_excerpt.toLowerCase();
    for (const t of terms) {
      const idx = lower.indexOf(t);
      if (idx >= 0) {
        const start = Math.max(0, idx - 30);
        const end = Math.min(d.ocr_excerpt.length, idx + t.length + 50);
        let snip = d.ocr_excerpt.slice(start, end).trim();
        if (start > 0) snip = '‚Ä¶' + snip;
        if (end < d.ocr_excerpt.length) snip += '‚Ä¶';
        const re = new RegExp('(' + terms.map(tt => tt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|') + ')', 'gi');
        snip = esc(snip).replace(re, '<mark>$1</mark>');
        return snip;
      }
    }
  }
  return '';
}
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtRange(b, d) {
  if (!b && !d) return '';
  const by = b ? (b.match(/(\d{4})/)?.[1]||b) : '?';
  const dy = d ? (d.match(/(\d{4})/)?.[1]||d) : '';
  return dy ? `${by} ‚Äì ${dy}` : `b. ${by}`;
}

const searchInput = document.getElementById('search-input');
const searchDD    = document.getElementById('search-dd');
const ocrBtn      = document.getElementById('ocr-search-btn');

ocrBtn.addEventListener('click', () => {
  ocrMode = !ocrMode;
  ocrBtn.classList.toggle('active', ocrMode);
  searchInput.placeholder = ocrMode
    ? 'Search names + OCR text‚Ä¶ use & for AND, | for OR'
    : 'Search by name‚Ä¶ use & for AND, | for OR';
  searchInput.dispatchEvent(new Event('input'));
});

searchInput.addEventListener('input', () => {
  if (!profileIndex.length) return;
  const q = searchInput.value.trim();
  if (q.length < 2) { searchDD.classList.remove('open'); return; }
  const orGroups = parseSearchQuery(q);
  if (!orGroups.length || orGroups.every(g => !g.length)) { searchDD.classList.remove('open'); return; }

  const nameMatches = [];
  const ocrMatches = [];
  for (const p of profileIndex) {
    const result = matchProfile(p, orGroups, ocrMode);
    if (!result.match) continue;
    if (result.via === 'name') nameMatches.push({ ...p, via: 'name' });
    else ocrMatches.push({ ...p, via: 'ocr', matchTerms: result.terms });
    if (nameMatches.length + ocrMatches.length >= 50) break;
  }
  const matches = [...nameMatches, ...ocrMatches];

  if (!matches.length) {
    searchDD.innerHTML = '<div class="sr" style="color:var(--fg2); cursor:default;">No results</div>';
    searchDD.classList.add('open'); return;
  }
  searchDD.innerHTML = matches.map(m => {
    const dates = fmtRange(m.birth_date, m.death_date);
    const tc = TIER_COLORS[m.confidence_tier]||'#999';
    const tb = TIER_BG[m.confidence_tier]||'#f0f0f0';
    let snippet = '';
    let viaTag = '';
    if (m.via === 'ocr') {
      snippet = `<div class="sr-ocr-snippet">${getOcrSnippet(m.id, m.matchTerms)}</div>`;
      viaTag = '<span class="sr-via">OCR</span>';
    }
    return `<div class="sr" data-id="${m.id}">
      <div>
        <span class="sr-name">${esc(m.name)}</span>${viaTag}
        <span class="sr-sub">${dates}</span>
        ${snippet}
      </div>
      <span class="sr-tier" style="background:${tb};color:${tc};">${m.confidence_tier||'?'}</span>
    </div>`;
  }).join('');
  searchDD.classList.add('open');
  searchDD.querySelectorAll('.sr[data-id]').forEach(el => {
    el.addEventListener('click', () => {
      window.location.href = `/profile.html?id=${el.dataset.id}`;
    });
  });
});
searchInput.addEventListener('keydown', e => { if (e.key==='Escape') searchDD.classList.remove('open'); });
document.addEventListener('click', e => { if (!e.target.closest('.search-wrap') && !e.target.closest('.search-controls')) searchDD.classList.remove('open'); });
</script>
<script src="/data/help-widget.js"></script>
<script>
initHelp({
  title: 'Dashboard',
  intro: 'The home page of Lack Lineage ‚Äî a family history project built from George Lack\'s genealogical research database.',
  keyboard: [
    { key: '?', action: 'Toggle this help panel' }
  ],
  mouse: [
    { key: 'Left-click nav link', action: 'Navigate to that page' },
    { key: 'Left-click stat card', action: 'View details for that statistic' }
  ],
  sections: [
    { title: 'Overview', icon: 'üìä', html: `
      <p>The dashboard shows live statistics pulled from the database: total people, unique surnames, relationships, and confidence scores.</p>
      <p>Stats update automatically when <code>stats.json</code> is regenerated from the database.</p>
    ` },
    { title: 'Navigation', icon: 'üß≠', html: `
      <p>Use the top navigation bar to visit any page:</p>
      <ul>
        <li><strong>Tree</strong> ‚Äî Collapsible tree explorer with ancestors/descendants/both modes</li>
        <li><strong>Ancestry</strong> ‚Äî Pedigree chart with draggable cards</li>
        <li><strong>Documents</strong> ‚Äî Browse scanned family records with OCR text</li>
        <li><strong>Surnames</strong> ‚Äî Browse all family surnames with counts</li>
        <li><strong>Living</strong> ‚Äî Animated timeline of who was alive each year</li>
        <li><strong>Related</strong> ‚Äî Find relationship paths between any two people</li>
        <li><strong>Letter</strong> ‚Äî A letter to George summarizing the project</li>
        <li><strong>Visualizations</strong> ‚Äî Plans for thirteen visualization pieces</li>
      </ul>
    ` }
  ]
});
</script>
</body>
</html>
