<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lack Lineage — Ancestry View</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #e8e4dc;
  --card-bg: #ffffff;
  --card-hover: #faf8f5;
  --text: #333333;
  --text2: #706b63;
  --text3: #9e9a93;
  --accent: #457b3b;
  --accent-hover: #3a6b32;
  --accent-light: #e8f0e6;
  --male: #3b74a3;
  --female: #a3527a;
  --border: #d4cfc7;
  --shadow: 0 2px 8px rgba(0,0,0,0.12);
  --shadow-hover: 0 4px 16px rgba(0,0,0,0.18);
  --radius: 8px;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --line-color: #b8b2a8;
}
html, body { height: 100%; overflow: hidden; }
body { font-family: var(--font); color: var(--text); background: var(--bg); }

/* ── Top bar (Ancestry-style green bar) ── */
.topbar {
  background: #2d5f27;
  background: linear-gradient(180deg, #3a7232 0%, #2d5f27 100%);
  color: #fff;
  height: 52px;
  display: flex;
  align-items: center;
  padding: 0 1.2rem;
  gap: 1rem;
  z-index: 100;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.topbar .logo {
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  white-space: nowrap;
  text-decoration: none;
  color: #fff;
}
.topbar .logo span { font-weight: 300; opacity: 0.7; }

/* Nav tabs */
.topbar nav { display: flex; gap: 0.15rem; margin-left: 1rem; }
.topbar nav a {
  color: rgba(255,255,255,0.8);
  text-decoration: none;
  padding: 0.4rem 0.8rem;
  border-radius: 4px 4px 0 0;
  font-size: 0.82rem;
  transition: all 0.15s;
}
.topbar nav a:hover { color: #fff; background: rgba(255,255,255,0.12); }
.topbar nav a.active { color: #fff; background: rgba(255,255,255,0.2); font-weight: 600; }

/* Search in topbar */
.topbar-search {
  margin-left: auto;
  position: relative;
}
.topbar-search input {
  width: 240px;
  padding: 0.4rem 0.8rem 0.4rem 2rem;
  border: none;
  border-radius: 4px;
  font-size: 0.82rem;
  font-family: var(--font);
  background: rgba(255,255,255,0.2);
  color: #fff;
  outline: none;
  transition: all 0.2s;
}
.topbar-search input::placeholder { color: rgba(255,255,255,0.6); }
.topbar-search input:focus { background: rgba(255,255,255,0.95); color: var(--text); width: 300px; }
.topbar-search input:focus::placeholder { color: var(--text3); }
.topbar-search .search-icon {
  position: absolute;
  left: 0.6rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.85rem;
  opacity: 0.6;
  pointer-events: none;
}
.topbar-search .search-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow-hover);
  max-height: 320px;
  overflow-y: auto;
  display: none;
  z-index: 200;
}
.topbar-search .search-dropdown.show { display: block; }
.search-item {
  padding: 0.6rem 0.8rem;
  cursor: pointer;
  border-bottom: 1px solid #f0ede8;
  transition: background 0.1s;
}
.search-item:hover { background: #f7f5f2; }
.search-item:last-child { border-bottom: none; }
.search-item .si-name { font-weight: 600; font-size: 0.85rem; color: var(--text); }
.search-item .si-dates { font-size: 0.75rem; color: var(--text2); }

/* ── Breadcrumb / person info bar ── */
.info-bar {
  background: #f5f2ec;
  border-bottom: 1px solid var(--border);
  padding: 0.5rem 1.2rem;
  display: flex;
  align-items: center;
  gap: 0.8rem;
  font-size: 0.82rem;
  z-index: 50;
  position: relative;
}
.info-bar .root-name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
}
.info-bar .root-dates { color: var(--text2); }
.info-bar .breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  margin-left: auto;
  color: var(--text3);
  font-size: 0.78rem;
}
.info-bar .breadcrumb a {
  color: var(--accent);
  text-decoration: none;
  cursor: pointer;
}
.info-bar .breadcrumb a:hover { text-decoration: underline; }
.info-bar .breadcrumb .sep { opacity: 0.4; }
.back-btn, .home-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  font-family: var(--font);
  font-size: 0.78rem;
  color: var(--text2);
  transition: all 0.15s;
}
.back-btn:hover, .home-btn:hover { background: #fff; border-color: #bbb; color: var(--text); }

/* ── SVG canvas ── */
#canvas { display: block; cursor: grab; background: var(--bg); }
#canvas:active { cursor: grabbing; }

/* ── Person card (rendered as foreignObject in SVG) ── */
.person-card {
  width: 200px;
  height: 80px;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0 0.7rem;
  transition: box-shadow 0.2s, transform 0.15s;
  border: 2px solid transparent;
  overflow: hidden;
  user-select: none;
}
.person-card:hover {
  box-shadow: var(--shadow-hover);
  transform: scale(1.02);
}
.person-card.male { border-left: 4px solid var(--male); }
.person-card.female { border-left: 4px solid var(--female); }
.person-card.unknown-sex { border-left: 4px solid var(--text3); }
.person-card.root-card {
  border: 2px solid var(--accent);
  background: var(--accent-light);
}

/* Avatar silhouette */
.card-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #eae7e0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 1.1rem;
  color: var(--text3);
}
.card-avatar.male-av { background: #dce7f0; color: var(--male); }
.card-avatar.female-av { background: #f0dce7; color: var(--female); }

/* Card text */
.card-info { flex: 1; min-width: 0; }
.card-name {
  font-weight: 600;
  font-size: 0.82rem;
  color: var(--text);
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-dates {
  font-size: 0.72rem;
  color: var(--text2);
  margin-top: 2px;
}
.card-place {
  font-size: 0.68rem;
  color: var(--text3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Expand indicator on card */
.card-expand {
  position: absolute;
  right: -12px;
  top: 50%;
  transform: translateY(-50%);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 5;
}

/* ── Empty slot (dashed outline for missing parent) ── */
.empty-slot {
  width: 200px;
  height: 80px;
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text3);
  font-size: 0.75rem;
  cursor: default;
  background: rgba(255,255,255,0.3);
}

/* ── Detail modal ── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 300;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.25);
  width: 420px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 1.5rem;
  position: relative;
}
.modal-close {
  position: absolute;
  top: 0.8rem;
  right: 0.8rem;
  background: none;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  color: var(--text3);
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.15s;
}
.modal-close:hover { background: #f0ede8; color: var(--text); }
.modal h2 { font-size: 1.15rem; margin-bottom: 0.2rem; }
.modal .modal-subtitle { color: var(--text2); font-size: 0.82rem; margin-bottom: 1rem; }
.modal-section { margin-top: 1rem; }
.modal-section h4 { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.4rem; }
.modal-section p { font-size: 0.85rem; line-height: 1.6; color: var(--text2); }
.modal-section ul { list-style: none; padding: 0; }
.modal-section li { padding: 0.2rem 0; font-size: 0.85rem; }
.modal-section a { color: var(--accent); cursor: pointer; text-decoration: none; }
.modal-section a:hover { text-decoration: underline; }
.modal-btn {
  display: inline-block;
  margin-top: 0.8rem;
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 0.45rem 1rem;
  border-radius: 6px;
  font-family: var(--font);
  font-size: 0.82rem;
  cursor: pointer;
  transition: background 0.15s;
}
.modal-btn:hover { background: var(--accent-hover); }

/* ── Zoom controls ── */
.zoom-controls {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 50;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.zoom-controls button {
  width: 36px;
  height: 36px;
  background: var(--card-bg);
  border: none;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  font-size: 1.1rem;
  color: var(--text2);
  transition: all 0.1s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.zoom-controls button:last-child { border-bottom: none; }
.zoom-controls button:hover { background: #f0ede8; color: var(--text); }

/* ── Generation labels ── */
.gen-label {
  font-family: var(--font);
  font-size: 11px;
  fill: var(--text3);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* ── Loading ── */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(232,228,220,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 250;
}
.loading-overlay.show { display: flex; }
.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <a href="/" class="logo">Lack <span>Lineage</span></a>
  <nav>
    <a href="/">Dashboard</a>
    <a href="/graph.html">Graph</a>
    <a href="/tree.html">Tree</a>
    <a href="/ancestry.html" class="active">Ancestry</a>
  </nav>
  <div class="topbar-search">
    <span class="search-icon">&#128269;</span>
    <input type="text" id="search" placeholder="Search for a person…" autocomplete="off">
    <div class="search-dropdown" id="search-dropdown"></div>
  </div>
</div>

<!-- Info bar -->
<div class="info-bar">
  <button class="back-btn" id="btn-back" title="Go back">&#8592; Back</button>
  <button class="home-btn" id="btn-home" title="Return to George">&#8962; Home</button>
  <span class="root-name" id="root-name">—</span>
  <span class="root-dates" id="root-dates"></span>
  <div class="breadcrumb" id="breadcrumb"></div>
</div>

<!-- Canvas -->
<svg id="canvas"></svg>

<!-- Zoom controls -->
<div class="zoom-controls">
  <button id="btn-zoomin" title="Zoom in">+</button>
  <button id="btn-zoomout" title="Zoom out">−</button>
  <button id="btn-fit" title="Fit to view">⊡</button>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
</div>

<!-- Detail modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <button class="modal-close" id="modal-close">&times;</button>
    <div id="modal-content"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════
const CARD_W = 200;
const CARD_H = 80;
const H_GAP = 60;        // horizontal gap between generations
const V_GAP = 16;         // minimum vertical gap between cards
const DEFAULT_ROOT = 2161; // George l Lack
const DEFAULT_DEPTH = 8;
const GEN_LABELS = ['You', 'Parents', 'Grandparents', 'Gt-Grandparents',
  '2x Gt-Grandparents', '3x Gt-Grandparents', '4x Gt-Grandparents',
  '5x Gt-Grandparents', '6x Gt-Grandparents', '7x Gt-Grandparents',
  '8x Gt-Grandparents', '9x Gt-Grandparents', '10x Gt-Grandparents',
  '11x Gt-Grandparents', '12x Gt-Grandparents'];

// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let currentRoot = DEFAULT_ROOT;
let depth = DEFAULT_DEPTH;
let history = [];
let treeData = null;
let svg, gMain, zoomBehavior;

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function fmtYear(d) {
  if (!d) return '';
  const m = String(d).match(/\b(1[4-9]\d{2}|20[0-2]\d)\b/);
  return m ? m[1] : '';
}

function lifespan(p) {
  const b = fmtYear(p.birth);
  const d = fmtYear(p.death);
  if (!b && !d) return '';
  if (!d) return `b. ${b}`;
  if (!b) return `d. ${d}`;
  return `${b} – ${d}`;
}

function sexClass(s) {
  if (s === 'M') return 'male';
  if (s === 'F') return 'female';
  return 'unknown-sex';
}

function avatarSvg(sex) {
  if (sex === 'M') return `<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><circle cx="12" cy="8" r="4"/><path d="M12 14c-5 0-8 2.5-8 5v1h16v-1c0-2.5-3-5-8-5z"/></svg>`;
  if (sex === 'F') return `<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><circle cx="12" cy="8" r="4"/><path d="M12 14c-5 0-8 2.5-8 5v1h16v-1c0-2.5-3-5-8-5z"/></svg>`;
  return `<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><circle cx="12" cy="8" r="4" opacity="0.5"/><path d="M12 14c-5 0-8 2.5-8 5v1h16v-1c0-2.5-3-5-8-5z" opacity="0.5"/></svg>`;
}

// ═══════════════════════════════════════════
// SVG INIT
// ═══════════════════════════════════════════
function initCanvas() {
  const el = document.getElementById('canvas');
  const topH = document.querySelector('.topbar').offsetHeight;
  const infoH = document.querySelector('.info-bar').offsetHeight;
  const h = window.innerHeight - topH - infoH;
  el.style.width = '100%';
  el.style.height = h + 'px';

  svg = d3.select('#canvas');
  svg.selectAll('*').remove();

  gMain = svg.append('g').attr('class', 'main-group');

  zoomBehavior = d3.zoom()
    .scaleExtent([0.1, 2.5])
    .on('zoom', (event) => gMain.attr('transform', event.transform));
  svg.call(zoomBehavior);
}

// ═══════════════════════════════════════════
// PEDIGREE LAYOUT
// Ancestry-style: root left, ancestors fan right
// Each gen: gen0 has 1 slot, gen1 has 2, gen2 has 4, etc.
// Position is deterministic — slot i in gen g maps to
// specific y position based on the subtree height.
// ═══════════════════════════════════════════

function layoutPedigree(data, maxGens) {
  // Flatten tree into positioned nodes
  const nodes = [];
  const links = [];

  // Total height based on deepest generation
  const leafCount = Math.pow(2, maxGens - 1);
  const totalH = leafCount * (CARD_H + V_GAP);

  function place(node, gen, yMin, yMax) {
    if (!node) return null;
    const yMid = (yMin + yMax) / 2;
    const x = gen * (CARD_W + H_GAP);
    const y = yMid - CARD_H / 2;

    const positioned = {
      ...node,
      x, y,
      yMid,
      gen,
      hasHiddenParents: !!(node._parents && node._parents.length > 0)
    };
    nodes.push(positioned);

    // parents array
    const parents = node.parents || [];
    // In a pedigree, index 0 = father (top), index 1 = mother (bottom)
    // but we just take them in order
    if (parents.length > 0 || gen < maxGens - 1) {
      const father = parents[0] || null;
      const mother = parents[1] || null;

      const halfH = (yMax - yMin) / 2;

      if (father) {
        const fNode = place(father, gen + 1, yMin, yMin + halfH);
        if (fNode) links.push({ source: positioned, target: fNode });
      } else if (gen < maxGens - 1) {
        // Empty slot for father
        const ey = (yMin + yMin + halfH) / 2 - CARD_H / 2;
        const ex = (gen + 1) * (CARD_W + H_GAP);
        nodes.push({ id: `empty-f-${node.id}-${gen}`, empty: true, x: ex, y: ey, yMid: ey + CARD_H / 2, gen: gen + 1 });
      }

      if (mother) {
        const mNode = place(mother, gen + 1, yMin + halfH, yMax);
        if (mNode) links.push({ source: positioned, target: mNode });
      } else if (gen < maxGens - 1) {
        const ey = (yMin + halfH + yMax) / 2 - CARD_H / 2;
        const ex = (gen + 1) * (CARD_W + H_GAP);
        nodes.push({ id: `empty-m-${node.id}-${gen}`, empty: true, x: ex, y: ey, yMid: ey + CARD_H / 2, gen: gen + 1 });
      }
    }

    return positioned;
  }

  // Determine actual maxGens from data
  function treeDepth(n, d = 0) {
    if (!n) return d;
    const parents = n.parents || [];
    let maxD = d;
    for (const p of parents) {
      maxD = Math.max(maxD, treeDepth(p, d + 1));
    }
    return maxD;
  }

  const actualDepth = Math.min(treeDepth(data) + 1, maxGens);
  const actualLeaves = Math.pow(2, actualDepth - 1);
  const actualH = actualLeaves * (CARD_H + V_GAP);

  place(data, 0, 0, actualH);

  return { nodes, links, totalW: actualDepth * (CARD_W + H_GAP), totalH: actualH };
}

// ═══════════════════════════════════════════
// FETCH & RENDER
// ═══════════════════════════════════════════

async function fetchAncestors(rootId, depth) {
  document.getElementById('loading').classList.add('show');
  try {
    const resp = await fetch(`/api/ancestors?id=${rootId}&depth=${depth}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);
    return data;
  } catch (err) {
    console.error('Fetch error:', err);
    return null;
  } finally {
    document.getElementById('loading').classList.remove('show');
  }
}

async function loadAndRender() {
  const data = await fetchAncestors(currentRoot, depth);
  if (!data) return;
  treeData = data;
  render(data);
  updateInfoBar(data);
  updateURL();
  setTimeout(fitToView, 50);
}

function render(data) {
  gMain.selectAll('*').remove();

  const layout = layoutPedigree(data, depth);
  const { nodes, links, totalW, totalH } = layout;

  // ── Generation labels ──
  const gensUsed = new Set(nodes.map(n => n.gen));
  for (const gen of gensUsed) {
    const x = gen * (CARD_W + H_GAP) + CARD_W / 2;
    gMain.append('text')
      .attr('class', 'gen-label')
      .attr('x', x)
      .attr('y', -20)
      .attr('text-anchor', 'middle')
      .text(GEN_LABELS[gen] || `Gen ${gen}`);
  }

  // ── Connection lines ──
  const lineGroup = gMain.append('g').attr('class', 'connections');
  for (const link of links) {
    const sx = link.source.x + CARD_W;
    const sy = link.source.yMid;
    const tx = link.target.x;
    const ty = link.target.yMid;
    const mx = sx + (tx - sx) * 0.5;

    lineGroup.append('path')
      .attr('d', `M${sx},${sy} C${mx},${sy} ${mx},${ty} ${tx},${ty}`)
      .attr('fill', 'none')
      .attr('stroke', 'var(--line-color)')
      .attr('stroke-width', 2)
      .attr('opacity', 0.7);
  }

  // ── Person cards ──
  const cardGroup = gMain.append('g').attr('class', 'cards');

  for (const node of nodes) {
    if (node.empty) {
      // Empty/dashed slot
      const fo = cardGroup.append('foreignObject')
        .attr('x', node.x)
        .attr('y', node.y)
        .attr('width', CARD_W)
        .attr('height', CARD_H);

      const div = fo.append('xhtml:div')
        .attr('class', 'empty-slot');
      div.html(`<span>Add Father/Mother</span>`);
      continue;
    }

    const isRoot = node.gen === 0;
    const fo = cardGroup.append('foreignObject')
      .attr('x', node.x)
      .attr('y', node.y)
      .attr('width', CARD_W)
      .attr('height', CARD_H)
      .style('overflow', 'visible');

    const sexCls = sexClass(node.sex);
    const avCls = node.sex === 'M' ? 'male-av' : node.sex === 'F' ? 'female-av' : '';

    const card = fo.append('xhtml:div')
      .attr('class', `person-card ${sexCls} ${isRoot ? 'root-card' : ''}`)
      .attr('data-id', node.id);

    card.html(`
      <div class="card-avatar ${avCls}">${avatarSvg(node.sex)}</div>
      <div class="card-info">
        <div class="card-name" title="${node.name || 'Unknown'}">${node.name || 'Unknown'}</div>
        <div class="card-dates">${lifespan(node)}</div>
      </div>
    `);

    // Click → navigate to this person as new root
    card.on('click', function(event) {
      event.stopPropagation();
      if (event.shiftKey || event.ctrlKey) {
        // Shift/Ctrl+click → show detail modal
        showModal(node.id);
      } else {
        navigateTo(node.id, node.name);
      }
    });

    // Right-click → detail modal
    card.on('contextmenu', function(event) {
      event.preventDefault();
      showModal(node.id);
    });

    // Double-click → detail modal
    card.on('dblclick', function(event) {
      event.preventDefault();
      event.stopPropagation();
      showModal(node.id);
    });
  }
}

// ═══════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════

function navigateTo(id, name) {
  if (id === currentRoot) return;
  history.push({ id: currentRoot, name: document.getElementById('root-name').textContent });
  currentRoot = id;
  loadAndRender();
}

function goBack() {
  if (history.length === 0) return;
  const prev = history.pop();
  currentRoot = prev.id;
  loadAndRender();
}

function goHome() {
  if (currentRoot === DEFAULT_ROOT) return;
  history.push({ id: currentRoot, name: document.getElementById('root-name').textContent });
  currentRoot = DEFAULT_ROOT;
  loadAndRender();
}

function updateInfoBar(data) {
  document.getElementById('root-name').textContent = data.name || 'Unknown';
  document.getElementById('root-dates').textContent = lifespan(data);

  // Breadcrumb
  const bc = document.getElementById('breadcrumb');
  if (history.length === 0) {
    bc.innerHTML = '';
    return;
  }
  const trail = history.slice(-4); // show last 4
  let html = '';
  if (history.length > 4) html += '<span class="sep">…</span> <span class="sep">›</span> ';
  trail.forEach((h, i) => {
    html += `<a data-idx="${history.length - trail.length + i}">${h.name}</a>`;
    html += ' <span class="sep">›</span> ';
  });
  html += `<strong>${data.name}</strong>`;
  bc.innerHTML = html;

  bc.querySelectorAll('a').forEach(a => {
    a.addEventListener('click', () => {
      const idx = parseInt(a.dataset.idx);
      const target = history[idx];
      // Truncate history to that point
      history = history.slice(0, idx);
      currentRoot = target.id;
      loadAndRender();
    });
  });
}

// ═══════════════════════════════════════════
// DETAIL MODAL
// ═══════════════════════════════════════════

async function showModal(personId) {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  content.innerHTML = '<p style="color:var(--text3)">Loading…</p>';
  overlay.classList.add('show');

  try {
    const resp = await fetch(`/api/person/${personId}`);
    const d = await resp.json();

    let html = `<h2>${d.given_name || ''} ${d.surname || ''}</h2>`;
    html += `<div class="modal-subtitle">ID ${d.id}</div>`;

    html += '<div class="modal-section"><h4>Vital Information</h4>';
    if (d.birth_date || d.birth_place) {
      html += `<p><strong>Born:</strong> ${d.birth_date || '?'}`;
      if (d.birth_place) html += ` — ${d.birth_place}`;
      html += '</p>';
    }
    if (d.death_date || d.death_place) {
      html += `<p><strong>Died:</strong> ${d.death_date || '?'}`;
      if (d.death_place) html += ` — ${d.death_place}`;
      html += '</p>';
    }
    if (d.sex) html += `<p><strong>Sex:</strong> ${d.sex === 'M' ? 'Male' : d.sex === 'F' ? 'Female' : d.sex}</p>`;
    html += '</div>';

    if (d.parents && d.parents.length > 0) {
      html += '<div class="modal-section"><h4>Parents</h4><ul>';
      for (const p of d.parents) {
        html += `<li><a data-nav="${p.id}">${p.given_name || ''} ${p.surname || ''}</a></li>`;
      }
      html += '</ul></div>';
    }

    if (d.spouses && d.spouses.length > 0) {
      html += '<div class="modal-section"><h4>Spouses</h4><ul>';
      for (const s of d.spouses) {
        html += `<li><a data-nav="${s.id}">${s.given_name || ''} ${s.surname || ''}</a></li>`;
      }
      html += '</ul></div>';
    }

    if (d.children && d.children.length > 0) {
      html += '<div class="modal-section"><h4>Children</h4><ul>';
      for (const c of d.children) {
        html += `<li><a data-nav="${c.id}">${c.given_name || ''} ${c.surname || ''}</a></li>`;
      }
      html += '</ul></div>';
    }

    if (d.siblings && d.siblings.length > 0) {
      html += '<div class="modal-section"><h4>Siblings</h4><ul>';
      for (const s of d.siblings) {
        html += `<li><a data-nav="${s.id}">${s.given_name || ''} ${s.surname || ''}</a></li>`;
      }
      html += '</ul></div>';
    }

    html += `<button class="modal-btn" data-nav="${d.id}">View tree from this person</button>`;
    content.innerHTML = html;

    // Wire up nav links inside modal
    content.querySelectorAll('[data-nav]').forEach(el => {
      el.addEventListener('click', () => {
        overlay.classList.remove('show');
        navigateTo(parseInt(el.dataset.nav), el.textContent.trim());
      });
    });

  } catch (err) {
    content.innerHTML = `<p style="color:#c44">Error: ${err.message}</p>`;
  }
}

// ═══════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════

let searchTimer = null;
const searchInput = document.getElementById('search');
const searchDropdown = document.getElementById('search-dropdown');

searchInput.addEventListener('input', function() {
  clearTimeout(searchTimer);
  const q = this.value.trim();
  if (q.length < 2) {
    searchDropdown.classList.remove('show');
    return;
  }
  searchTimer = setTimeout(async () => {
    try {
      const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
      const results = await resp.json();
      if (results.length === 0) {
        searchDropdown.innerHTML = '<div class="search-item"><span class="si-dates">No results</span></div>';
      } else {
        searchDropdown.innerHTML = results.slice(0, 12).map(p => {
          const name = `${p.given_name || ''} ${p.surname || ''}`.trim() || 'Unknown';
          const dates = [p.birth_date, p.death_date].filter(Boolean).join(' – ') || 'no dates';
          return `<div class="search-item" data-id="${p.id}" data-name="${name}">
            <div class="si-name">${name}</div>
            <div class="si-dates">${dates}</div>
          </div>`;
        }).join('');
      }
      searchDropdown.classList.add('show');
    } catch (e) {
      searchDropdown.classList.remove('show');
    }
  }, 200);
});

searchDropdown.addEventListener('click', function(e) {
  const item = e.target.closest('.search-item');
  if (item && item.dataset.id) {
    searchDropdown.classList.remove('show');
    searchInput.value = item.dataset.name;
    navigateTo(parseInt(item.dataset.id), item.dataset.name);
  }
});

document.addEventListener('click', e => {
  if (!e.target.closest('.topbar-search')) {
    searchDropdown.classList.remove('show');
  }
});

searchInput.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    searchDropdown.classList.remove('show');
    this.blur();
  }
});

// ═══════════════════════════════════════════
// ZOOM CONTROLS
// ═══════════════════════════════════════════

function fitToView() {
  const bounds = gMain.node().getBBox();
  if (bounds.width === 0 || bounds.height === 0) return;
  const el = document.getElementById('canvas');
  const w = el.clientWidth;
  const h = el.clientHeight;
  const pad = 80;
  const scale = Math.min(
    (w - pad * 2) / bounds.width,
    (h - pad * 2) / bounds.height,
    1.2
  );
  const tx = (w - bounds.width * scale) / 2 - bounds.x * scale;
  const ty = (h - bounds.height * scale) / 2 - bounds.y * scale;
  svg.transition().duration(400)
    .call(zoomBehavior.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
}

document.getElementById('btn-zoomin').addEventListener('click', () =>
  svg.transition().duration(200).call(zoomBehavior.scaleBy, 1.4));
document.getElementById('btn-zoomout').addEventListener('click', () =>
  svg.transition().duration(200).call(zoomBehavior.scaleBy, 0.7));
document.getElementById('btn-fit').addEventListener('click', fitToView);

// ═══════════════════════════════════════════
// BUTTONS
// ═══════════════════════════════════════════

document.getElementById('btn-back').addEventListener('click', goBack);
document.getElementById('btn-home').addEventListener('click', goHome);

document.getElementById('modal-close').addEventListener('click', () =>
  document.getElementById('modal-overlay').classList.remove('show'));
document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('show');
});

// ═══════════════════════════════════════════
// URL STATE
// ═══════════════════════════════════════════

function updateURL() {
  const params = new URLSearchParams();
  if (currentRoot !== DEFAULT_ROOT) params.set('root', currentRoot);
  if (depth !== DEFAULT_DEPTH) params.set('depth', depth);
  const qs = params.toString();
  window.history.replaceState(null, '', window.location.pathname + (qs ? '?' + qs : ''));
}

function readURL() {
  const params = new URLSearchParams(window.location.search);
  if (params.has('root')) currentRoot = parseInt(params.get('root'));
  if (params.has('depth')) depth = parseInt(params.get('depth'));
}

// ═══════════════════════════════════════════
// RESIZE
// ═══════════════════════════════════════════

window.addEventListener('resize', () => {
  const topH = document.querySelector('.topbar').offsetHeight;
  const infoH = document.querySelector('.info-bar').offsetHeight;
  document.getElementById('canvas').style.height = (window.innerHeight - topH - infoH) + 'px';
});

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════

readURL();
initCanvas();
loadAndRender();
</script>
</body>
</html>
